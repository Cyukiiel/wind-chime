
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>風鈴 · Fūrin (Night)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{ --ink:#e6eefc; --soft:#0b1220; --accent:#60a5ff; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
    background: radial-gradient(1200px 800px at 70% 10%, #0b1a33 0%, #061227 40%, #020914 100%);
    color: var(--ink);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  /* Fireworks canvas sits behind everything */
  #fireworks{
    position: fixed; inset: 0; z-index: 0; pointer-events:none;
  }
  .app{
    position: relative;
    z-index: 1;
    width: min(520px, 100vw);
    height: 100vh;
    background: rgba(5, 10, 20, 0.55);
    backdrop-filter: blur(3px);
    border-radius: 18px;
    display:flex; flex-direction:column; align-items:center;
    padding: env(safe-area-inset-top) 16px calc(10px + env(safe-area-inset-bottom));
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
  }
  .title{ width:100%; text-align:left; font-size:18px; color:#9fb7ff; margin:6px 0 0; }
  .canvas{
    position:relative; width:100%; flex:1 1 auto; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  .diagram{ width:360px; height:520px; position:relative; transform-origin: top center; }

  .yes{ position:absolute; top: 220px; left: 52%; color:#a7b4d9; font-size:16px; }
  .line{ position:absolute; top: 240px; left:50%; translate:-50% 0; width:3px; height:40px; background:#9fb7ff; opacity:.8; }
  /* Furin container */
  .furin{ position:absolute; top: 280px; left:50%; translate:-50% 0; }
  svg{ overflow:visible; }
  .controls{ width:100%; padding-top:8px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  button{
    flex:1 1 auto; padding:12px 14px; border-radius:14px; border:2px solid var(--accent);
    background:rgba(255,255,255,0.06); color: var(--ink); font-size:16px; font-weight:600;
  }
  button.on{ background: var(--accent); color:#00122a; border-color: var(--accent); }
  .row{ display:flex; width:100%; gap:10px; margin-top:6px; align-items:center; }
  .sliderWrap{ flex: 1 1 auto; display:flex; align-items:center; gap:10px; color:#98a7c9; font-size:14px; }
  input[type="range"]{ width:100%; }
  .note{ width:100%; text-align:center; color:#8fa5d6; font-size:12px; margin-top:4px;}
  .toggle{ border-color:#34d399; color:#bdfae2; }
  .toggle.on{ background:#34d399; color:#01251b; }
</style>
</head>
<body>
  <canvas id="fireworks"></canvas>

  <div class="app">
    <div class="title">這個是風鈴</div>
    <div class="canvas" id="canvas">
      <div class="diagram" id="diagram">

        <!-- Prettier diamond frame with SVG (night-styled) -->
        <div style="position:absolute; left:50%; top:20px; translate:-50% 0;">
          <svg width="240" height="240" viewBox="0 0 240 240" aria-label="风有在吹吗？">
            <defs>
              <linearGradient id="frameStroke" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#88b4ff"/>
                <stop offset="100%" stop-color="#3b82f6"/>
              </linearGradient>
              <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#001a3a" flood-opacity="0.7"/>
              </filter>
            </defs>
            <g transform="translate(120,120) rotate(45) translate(-120,-120)" filter="url(#softShadow)">
              <rect x="35" y="35" width="170" height="170" rx="22" ry="22"
                    fill="#0b1a33" stroke="url(#frameStroke)" stroke-width="6"/>
            </g>
            <text x="120" y="122" text-anchor="middle" dominant-baseline="middle"
                  font-size="20" font-weight="700" fill="#cfe0ff">風有在吹嗎？</text>
          </svg>
        </div>

        <div class="yes">yes</div>
        <div class="line"></div>

        <!-- FURIN (SVG) -->
        <div class="furin">
          <svg id="furin" width="200" height="240" viewBox="0 0 200 240">
            <line x1="100" y1="0" x2="100" y2="25" stroke="#9fb7ff" stroke-width="2"/>
            <g id="bellGroup" transform-origin="100px 25px">
              <defs>
                <radialGradient id="glassGrad" cx="50%" cy="40%" r="60%">
                  <stop offset="0%" stop-color="#cfe8ff" stop-opacity="0.95"/>
                  <stop offset="60%" stop-color="#9ec9ff" stop-opacity="0.35"/>
                  <stop offset="100%" stop-color="#4aa0ff" stop-opacity="0.18"/>
                </radialGradient>
                <linearGradient id="rimGrad" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#8fb9ff"/>
                  <stop offset="100%" stop-color="#4a98ff"/>
                </linearGradient>
              </defs>
              <path d="M50,80 Q100,10 150,80 L150,110 Q100,130 50,110 Z"
                    fill="url(#glassGrad)" stroke="#8db2ff" stroke-width="2"/>
              <ellipse cx="100" cy="80" rx="50" ry="10" fill="url(#rimGrad)" opacity="0.95"/>
              <line id="clapperLine" x1="100" y1="80" x2="100" y2="132" stroke="#9fb7ff" stroke-width="2"/>
              <circle id="clapper" cx="100" cy="140" r="10" fill="#c2d2ff" stroke="#8498cc"/>
            </g>
            <g id="tanzakuGroup" transform-origin="100px 140px">
              <line x1="100" y1="150" x2="100" y2="160" stroke="#9fb7ff" stroke-width="2"/>
              <rect x="85" y="160" width="30" height="70" rx="4" fill="#0f1c33" stroke="#324b7a" />
              <path d="M90 190 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
              <path d="M90 205 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
              <text id="tztext" x="100" y="167" text-anchor="middle" fill="#b7d0ff" font-size="14"
                    style="font-family:'Hiragino Sans','PingFang SC',sans-serif; writing-mode:vertical-rl; text-orientation:upright;">
                香橙布叮铃铃
              </text>
            </g>
          </svg>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="toggle">有風（開始）</button>
      <button id="one">只響一下</button>
      <button id="ambience" class="toggle on">海浪聲（開）</button>
      <button id="fireBtn" class="toggle on">花火（開）</button>
    </div>
    <div class="row">
      <div class="sliderWrap">
        <span>風速</span>
        <input id="rate" type="range" min="0" max="100" value="40">
      </div>
      <div id="status" style="min-width:92px; text-align:right; color:#a9befe; font-size:14px;">待機中</div>
    </div>
    <div class="note">夜空模式：更亮的花火与月光高光。</div>
  </div>

<script>
/* ---------- Responsive scale ---------- */
function fitDiagram(){
  const baseW = 360, baseH = 520;
  const container = document.getElementById('canvas');
  const target = document.getElementById('diagram');
  const w = container.clientWidth, h = container.clientHeight;
  const scale = Math.min(w/baseW, h/baseH);
  target.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', fitDiagram);
window.addEventListener('orientationchange', ()=>setTimeout(fitDiagram, 200));
setTimeout(fitDiagram, 0);

/* ---------- WebAudio: bell + ocean ---------- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let windTimer=null, running=false;

/* Bell */
function chime(){
  const now = ctx.currentTime;
  function bellTone(freq, t){
    const o = ctx.createOscillator();
    const m = ctx.createOscillator();
    const g = ctx.createGain();
    const mg = ctx.createGain();
    const out = ctx.createGain();

    o.type="sine"; o.frequency.value=freq;
    m.type="sine"; m.frequency.value=freq*1.5;
    mg.gain.value=400;

    g.gain.setValueAtTime(0, now+t);
    g.gain.linearRampToValueAtTime(0.9, now+t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+t+1.6);
    out.gain.value=0.55;

    m.connect(mg); mg.connect(o.frequency);
    o.connect(g).connect(out).connect(ctx.destination);
    o.start(now+t); m.start(now+t);
    o.stop(now+t+1.7); m.stop(now+t+1.7);
  }
  bellTone(1400, 0.00);
  bellTone(1000, 0.05);
  bellTone(1800, 0.18);

  swingOnce();
}
function scheduleLoop(){
  const rate = document.getElementById('rate').value;
  const baseMs = 2000 - rate*15;
  const jitter = Math.random()*600;
  windTimer = setTimeout(()=>{
    chime();
    if(running) scheduleLoop();
  }, Math.max(300, baseMs + jitter));
}
function startWind(){
  if(running) return;
  running = true;
  document.getElementById('toggle').classList.add('on');
  document.getElementById('toggle').textContent = '停風（停止）';
  document.getElementById('status').textContent = '風在吹：響鈴中…';
  scheduleLoop();
}
function stopWind(){
  running = false;
  document.getElementById('toggle').classList.remove('on');
  document.getElementById('toggle').textContent = '有風（開始）';
  document.getElementById('status').textContent = '待機中';
  clearTimeout(windTimer); windTimer=null;
}
document.getElementById('toggle').addEventListener('click', ()=>{
  if(ctx.state==='suspended') ctx.resume();
  running ? stopWind() : startWind();
});
document.getElementById('one').addEventListener('click', ()=>{
  if(ctx.state==='suspended') ctx.resume();
  chime();
});
document.getElementById('rate').addEventListener('input', ()=>{
  if(!running) return;
  clearTimeout(windTimer);
  scheduleLoop();
});

/* Ocean ambience (enabled by default in night mode) */
let ocean = { started:false, gain:null };
function ensureOcean(){
  if(!ocean.started){
    const noise = ctx.createScriptProcessor(2048,1,1);
    const filter = ctx.createBiquadFilter();
    const g = ctx.createGain();
    const lfo = ctx.createOscillator();
    const lfoGain = ctx.createGain();

    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    noise.onaudioprocess = function(e){
      const out = e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++){
        const white = Math.random()*2-1;
        b0 = 0.99886*b0 + white*0.0555179;
        b1 = 0.99332*b1 + white*0.0750759;
        b2 = 0.96900*b2 + white*0.1538520;
        b3 = 0.86650*b3 + white*0.3104856;
        b4 = 0.55000*b4 + white*0.5329522;
        b5 = -0.7616*b5 - white*0.0168980;
        out[i] = (b0+b1+b2+b3+b4+b5+b6 + white*0.5362)*0.08;
        b6 = white*0.115926;
      }
    };

    filter.type = "lowpass"; filter.frequency.value = 700;
    g.gain.value = 0.25;
    lfo.frequency.value = 0.08;
    lfoGain.gain.value = 0.35;
    lfo.connect(lfoGain);
    lfoGain.connect(g.gain);

    noise.connect(filter).connect(g).connect(ctx.destination);
    lfo.start();
    ocean = { started:true, gain:g };
  }
}
ensureOcean();

function toggleOcean(){
  ensureOcean();
  const btn = document.getElementById('ambience');
  if(btn.classList.contains('on')){
    ocean.gain.gain.cancelScheduledValues(ctx.currentTime);
    ocean.gain.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.6);
    btn.classList.remove('on'); btn.textContent = "海浪聲（關）";
  }else{
    if(ctx.state==='suspended') ctx.resume();
    ocean.gain.gain.cancelScheduledValues(ctx.currentTime);
    ocean.gain.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.8);
    btn.classList.add('on'); btn.textContent = "海浪聲（開）";
  }
}
document.getElementById('ambience').addEventListener('click', toggleOcean);

/* ---------- Background fireworks (glow & brighter) ---------- */
const canvas = document.getElementById('fireworks');
const fctx = canvas.getContext('2d', {alpha:true});
let fwEnabled = true;
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

const sparks = [];
function rand(min, max){ return Math.random()*(max-min)+min; }
function burst(x,y,color){
  const count = 100;
  for(let i=0;i<count;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = rand(1.2,3.6);
    sparks.push({
      x, y,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      life: rand(60,110),
      color,
      alpha: 1,
      size: rand(1.5,3)
    });
  }
}
function launchRandom(){
  if(!fwEnabled) return;
  const x = rand(0.15*canvas.width, 0.85*canvas.width);
  const y = rand(0.15*canvas.height, 0.5*canvas.height);
  const colors = ["#ffd166","#ff6a6a","#86e2ff","#b794f4","#78e08f","#f6a9d6","#fff5a3"];
  burst(x,y, colors[Math.floor(Math.random()*colors.length)]);
  setTimeout(launchRandom, rand(600, 1400));
}
launchRandom();

function step(){
  fctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=sparks.length-1;i>=0;i--){
    const p = sparks[i];
    p.x += p.vx; p.y += p.vy;
    p.vy += 0.02; // gravity
    p.life -= 1;
    p.alpha = Math.max(0, p.life/110);
    // glow
    fctx.globalCompositeOperation = 'lighter';
    fctx.shadowBlur = 10;
    fctx.shadowColor = p.color;
    fctx.globalAlpha = p.alpha;
    fctx.beginPath();
    fctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    fctx.fillStyle = p.color;
    fctx.fill();
    if(p.life<=0) sparks.splice(i,1);
  }
  requestAnimationFrame(step);
}
step();

document.getElementById('fireBtn').addEventListener('click', (e)=>{
  fwEnabled = !fwEnabled;
  e.target.classList.toggle('on', fwEnabled);
  e.target.textContent = fwEnabled ? "花火（開）" : "花火（關）";
  if(fwEnabled) launchRandom();
});

/* ---------- iOS unlock ---------- */
window.addEventListener('touchstart', ()=>{ if(ctx.state==='suspended') ctx.resume(); }, {once:true});
</script>
</body>
</html>
