
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>風鈴 · Fūrin (Natural Sway + Gusts)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{ --ink:#e6eefc; --accent:#60a5ff; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
    background: radial-gradient(1200px 800px at 70% 10%, #0b1a33 0%, #061227 40%, #020914 100%);
    color: var(--ink); display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  #fireworks{ position: fixed; inset: 0; z-index: 0; pointer-events:none; }
  .app{
    position: relative; z-index: 1;
    width: min(520px, 100vw); height: 100vh;
    background: rgba(5, 10, 20, 0.55);
    backdrop-filter: blur(3px);
    border-radius: 18px;
    display:flex; flex-direction:column; align-items:center;
    padding: env(safe-area-inset-top) 16px calc(10px + env(safe-area-inset-bottom));
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
  }
  .title{ width:100%; text-align:left; font-size:18px; color:#9fb7ff; margin:6px 0 0; }
  .canvas{ position:relative; width:100%; flex:1 1 auto; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .diagramWrap{ width:360px; height:520px; transform-origin: top center; }
  .controls{ width:100%; padding-top:8px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  button{
    flex:1 1 auto; padding:12px 14px; border-radius:14px; border:2px solid var(--accent);
    background:rgba(255,255,255,0.06); color: var(--ink); font-size:16px; font-weight:600;
  }
  button.on{ background: var(--accent); color:#00122a; border-color: var(--accent); }
  .row{ display:flex; width:100%; gap:10px; margin-top:6px; align-items:center; }
  .sliderWrap{ flex: 1 1 auto; display:flex; align-items:center; gap:10px; color:#98a7c9; font-size:14px; }
  input[type="range"]{ width:100%; }
  .note{ width:100%; text-align:center; color:#8fa5d6; font-size:12px; margin-top:4px;}
  .toggle{ border-color:#34d399; color:#bdfae2; }
  .toggle.on{ background:#34d399; color:#01251b; }
  .gust{ border-color:#f59e0b; color:#ffe9bf; }
  .gust.on{ background:#f59e0b; color:#1f1400; }
</style>
</head>
<body>
  <canvas id="fireworks"></canvas>

  <div class="app">
    <div class="title">這個是風鈴</div>
    <div class="canvas" id="canvas">
      <svg id="diagram" class="diagramWrap" viewBox="0 0 360 520" xmlns="http://www.w3.org/2000/svg" aria-label="flow and furin">
        <!-- Diamond (static) -->
        <defs>
          <linearGradient id="frameStroke" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#88b4ff"/><stop offset="100%" stop-color="#3b82f6"/>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#001a3a" flood-opacity="0.7"/>
          </filter>
          <radialGradient id="glassGrad" cx="50%" cy="40%" r="60%">
            <stop offset="0%" stop-color="#cfe8ff" stop-opacity="0.95"/>
            <stop offset="60%" stop-color="#9ec9ff" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#4aa0ff" stop-opacity="0.18"/>
          </radialGradient>
          <linearGradient id="rimGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#8fb9ff"/><stop offset="100%" stop-color="#4a98ff"/>
          </linearGradient>
        </defs>

        <!-- Center diamond at (180,120) -->
        <g transform="translate(180,120) rotate(45) translate(-85,-85)" filter="url(#softShadow)">
          <rect x="0" y="0" width="170" height="170" rx="22" ry="22" fill="#0b1a33" stroke="url(#frameStroke)" stroke-width="6"/>
        </g>
        <text x="180" y="120" text-anchor="middle" dominant-baseline="middle" font-size="20" font-weight="700" fill="#cfe0ff">風有在吹嗎？</text>

        <!-- Hanging assembly pivots from (180,220) -->
        <g id="assembly" transform="rotate(0 180 220)">
          <text x="205" y="220" fill="#a7b4d9" font-size="16">yes</text>
          <line x1="180" y1="200" x2="180" y2="220" stroke="#9fb7ff" stroke-width="3"/>
          <line x1="180" y1="220" x2="180" y2="240" stroke="#9fb7ff" stroke-width="3"/>

          <g id="bellGroup">
            <path d="M130,300 Q180,230 230,300 L230,330 Q180,350 130,330 Z" fill="url(#glassGrad)" stroke="#8db2ff" stroke-width="2"/>
            <ellipse cx="180" cy="300" rx="50" ry="10" fill="url(#rimGrad)" opacity="0.95"/>
            <line id="clapperLine" x1="180" y1="300" x2="180" y2="352" stroke="#9fb7ff" stroke-width="2"/>
            <circle id="clapper" cx="180" cy="360" r="10" fill="#c2d2ff" stroke="#8498cc"/>
          </g>
          <g id="tanzakuGroup">
            <line x1="180" y1="370" x2="180" y2="380" stroke="#9fb7ff" stroke-width="2"/>
            <rect x="165" y="380" width="30" height="70" rx="4" fill="#0f1c33" stroke="#324b7a" />
            <path d="M170 410 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <path d="M170 425 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <text id="tztext" x="180" y="385" text-anchor="middle" fill="#b7d0ff" font-size="14"
                  style="font-family:'Hiragino Sans','PingFang SC',sans-serif; writing-mode:vertical-rl; text-orientation:upright;">
              香橙布叮铃铃
            </text>
          </g>
        </g>
      </svg>
    </div>

    <div class="controls">
      <button id="toggle">有風（開始）</button>
      <button id="one">只響一下</button>
      <button id="gustBtn" class="gust">陣風（關）</button>
      <button id="ambience" class="toggle on">海浪聲（開）</button>
      <button id="fireBtn" class="toggle on">花火（開）</button>
    </div>
    <div class="row">
      <div class="sliderWrap">
        <span>風速</span>
        <input id="rate" type="range" min="0" max="100" value="40">
      </div>
      <div id="status" style="min-width:92px; text-align:right; color:#a9befe; font-size:14px;">待機中</div>
    </div>
    <div class="note">陣風模式：不規則的強風陣，會突然加大擺幅並快速連響。</div>
  </div>

<script>
/* ---------- Responsive scale ---------- */
function fitDiagram(){
  const baseW = 360, baseH = 520;
  const container = document.getElementById('canvas');
  const target = document.getElementById('diagram');
  const w = container.clientWidth, h = container.clientHeight;
  const scale = Math.min(w/baseW, h/baseH);
  target.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', fitDiagram);
window.addEventListener('orientationchange', ()=>setTimeout(fitDiagram, 200));
setTimeout(fitDiagram, 0);

/* ---------- WebAudio ---------- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let windTimer=null, running=false;

/* Bell chime */
function chime(){
  const now = ctx.currentTime;
  function bellTone(freq, t){
    const o = ctx.createOscillator();
    const m = ctx.createOscillator();
    const g = ctx.createGain();
    const mg = ctx.createGain();
    const out = ctx.createGain();

    o.type="sine"; o.frequency.value=freq;
    m.type="sine"; m.frequency.value=freq*1.5;
    mg.gain.value = 400;

    g.gain.setValueAtTime(0, now+t);
    g.gain.linearRampToValueAtTime(0.9, now+t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+t+1.6);
    out.gain.value=0.55;

    m.connect(mg); mg.connect(o.frequency);
    o.connect(g).connect(out).connect(ctx.destination);
    o.start(now+t); m.start(now+t);
    o.stop(now+t+1.7); m.stop(now+t+1.7);
  }
  bellTone(1400, 0.00);
  bellTone(1000, 0.05);
  bellTone(1800, 0.18);

  addImpulse();
}

/* ---------- Continuous natural sway ---------- */
let rafId = null;
let phase = 0;
let impulse = 0; // degrees
function addImpulse(extra=0){
  const rate = Number(document.getElementById('rate').value);
  impulse = Math.max(impulse, 6 + rate/10 + extra);
}
function windSwayLoop(){
  const rate = Number(document.getElementById('rate').value);
  const freq = 0.6 + rate/120;
  const baseAmp = 1 + rate/30;
  phase += (freq*2*Math.PI) / 60;
  impulse *= 0.94;
  const deg = Math.sin(phase) * (baseAmp + impulse);

  const asm = document.getElementById('assembly');
  asm.setAttribute('transform', `rotate(${deg} 180 220)`);

  const bell = document.getElementById('bellGroup');
  const tz = document.getElementById('tanzakuGroup');
  const clap = document.getElementById('clapper');
  bell.setAttribute('transform', `rotate(${deg*0.2} 180 300)`);
  tz.setAttribute('transform', `rotate(${deg*0.4} 180 370)`);
  clap.setAttribute('transform', `rotate(${deg*0.3} 180 300)`);

  rafId = requestAnimationFrame(windSwayLoop);
}

/* ---------- Gust Mode ---------- */
let gustEnabled = false;
let gustTimer = null;
function scheduleGust(){
  if(!gustEnabled || !running) return;
  const nextIn = 1200 + Math.random()*5000; // 1.2s ~ 6.2s
  gustTimer = setTimeout(()=>{
    // a burst of 1~3 quick chimes + strong impulse
    const bursts = 1 + Math.floor(Math.random()*3);
    const kick = 8 + Math.random()*8; // extra degrees
    addImpulse(kick);
    chime();
    let i=1;
    function more(){
      if(i>=bursts) return scheduleGust();
      addImpulse(kick * (0.7**i));
      chime();
      i++;
      setTimeout(more, 220 + Math.random()*280);
    }
    setTimeout(more, 220 + Math.random()*280);
  }, nextIn);
}
function toggleGust(){
  gustEnabled = !gustEnabled;
  const btn = document.getElementById('gustBtn');
  btn.classList.toggle('on', gustEnabled);
  btn.textContent = gustEnabled ? "陣風（開）" : "陣風（關）";
  if(gustEnabled) scheduleGust();
  else if(gustTimer){ clearTimeout(gustTimer); gustTimer=null; }
}
document.getElementById('gustBtn').addEventListener('click', toggleGust);

/* ---------- Wind controls ---------- */
function startWind(){
  if(running) return;
  running = true;
  document.getElementById('toggle').classList.add('on');
  document.getElementById('toggle').textContent = '停風（停止）';
  document.getElementById('status').textContent = '風在吹：響鈴中…';
  if(!rafId) rafId = requestAnimationFrame(windSwayLoop);
  scheduleLoop();
  scheduleGust();
}
function stopWind(){
  running = false;
  document.getElementById('toggle').classList.remove('on');
  document.getElementById('toggle').textContent = '有風（開始）';
  document.getElementById('status').textContent = '待機中';
  clearTimeout(windTimer); windTimer=null;
  if(gustTimer){ clearTimeout(gustTimer); gustTimer=null; }
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  document.getElementById('assembly').setAttribute('transform', `rotate(0 180 220)`);
  document.getElementById('bellGroup').setAttribute('transform', `rotate(0 180 300)`);
  document.getElementById('tanzakuGroup').setAttribute('transform', `rotate(0 180 370)`);
  document.getElementById('clapper').setAttribute('transform', `rotate(0 180 300)`);
}
function scheduleLoop(){
  const rate = Number(document.getElementById('rate').value);
  const baseMs = 2000 - rate*15;
  const jitter = Math.random()*600;
  windTimer = setTimeout(()=>{
    chime();
    if(running) scheduleLoop();
  }, Math.max(300, baseMs + jitter));
}

/* UI bindings */
document.getElementById('toggle').addEventListener('click', ()=>{
  if(ctx.state==='suspended') ctx.resume();
  running ? stopWind() : startWind();
});
document.getElementById('one').addEventListener('click', ()=>{
  if(ctx.state==='suspended') ctx.resume();
  chime();
  if(!running){
    addImpulse();
    if(!rafId){
      let frames=0;
      function tempLoop(){
        windSwayLoop();
        frames++;
        if(frames>90){ cancelAnimationFrame(rafId); rafId=null; stopWind(); }
      }
      requestAnimationFrame(tempLoop);
    }
  }
});
document.getElementById('rate').addEventListener('input', ()=>{});

/* Ocean ambience default ON */
const ctx2 = ctx;
let ocean = { started:false, gain:null };
function ensureOcean(){
  if(!ocean.started){
    const noise = ctx2.createScriptProcessor(2048,1,1);
    const filter = ctx2.createBiquadFilter();
    const g = ctx2.createGain();
    const lfo = ctx2.createOscillator();
    const lfoGain = ctx2.createGain();

    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    noise.onaudioprocess = function(e){
      const out = e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++){
        const white = Math.random()*2-1;
        b0 = 0.99886*b0 + white*0.0555179;
        b1 = 0.99332*b1 + white*0.0750759;
        b2 = 0.96900*b2 + white*0.1538520;
        b3 = 0.86650*b3 + white*0.3104856;
        b4 = 0.55000*b4 + white*0.5329522;
        b5 = -0.7616*b5 - white*0.0168980;
        out[i] = (b0+b1+b2+b3+b4+b5+b6 + white*0.5362)*0.08;
        b6 = white*0.115926;
      }
    };

    filter.type = "lowpass"; filter.frequency.value = 700;
    g.gain.value = 0.25;
    lfo.frequency.value = 0.08; lfoGain.gain.value = 0.35;
    lfo.connect(lfoGain); lfoGain.connect(g.gain);

    noise.connect(filter).connect(g).connect(ctx2.destination);
    lfo.start();
    ocean = { started:true, gain:g };
  }
}
ensureOcean();
document.getElementById('ambience').addEventListener('click', ()=>{
  ensureOcean();
  const btn = document.getElementById('ambience');
  if(btn.classList.contains('on')){
    ocean.gain.gain.cancelScheduledValues(ctx.currentTime);
    ocean.gain.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.6);
    btn.classList.remove('on'); btn.textContent = "海浪聲（關）";
  }else{
    if(ctx.state==='suspended') ctx.resume();
    ocean.gain.gain.cancelScheduledValues(ctx.currentTime);
    ocean.gain.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.8);
    btn.classList.add('on'); btn.textContent = "海浪聲（開）";
  }
});

/* Fireworks (glow) */
const canvas2 = document.getElementById('fireworks');
const fctx = canvas2.getContext('2d', {alpha:true});
let fwEnabled = true;
function resizeCanvas(){ canvas2.width = window.innerWidth; canvas2.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

const sparks = [];
function rand(min, max){ return Math.random()*(max-min)+min; }
function burst(x,y,color){
  const count = 100;
  for(let i=0;i<count;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = rand(1.2,3.6);
    sparks.push({ x, y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, life: rand(60,110), color, alpha: 1, size: rand(1.5,3)});
  }
}
function launchRandom(){
  if(!fwEnabled) return;
  const x = rand(0.15*canvas2.width, 0.85*canvas2.width);
  const y = rand(0.15*canvas2.height, 0.5*canvas2.height);
  const colors = ["#ffd166","#ff6a6a","#86e2ff","#b794f4","#78e08f","#f6a9d6","#fff5a3"];
  burst(x,y, colors[Math.floor(Math.random()*colors.length)]);
  setTimeout(launchRandom, rand(600, 1400));
}
launchRandom();
function step(){
  fctx.clearRect(0,0,canvas2.width,canvas2.height);
  for(let i=sparks.length-1;i>=0;i--){
    const p = sparks[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.life -= 1;
    p.alpha = Math.max(0, p.life/110);
    fctx.globalCompositeOperation = 'lighter';
    fctx.shadowBlur = 10; fctx.shadowColor = p.color; fctx.globalAlpha = p.alpha;
    fctx.beginPath(); fctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    fctx.fillStyle = p.color; fctx.fill();
    if(p.life<=0) sparks.splice(i,1);
  }
  requestAnimationFrame(step);
}
step();
document.getElementById('fireBtn').addEventListener('click', (e)=>{
  fwEnabled = !fwEnabled;
  e.target.classList.toggle('on', fwEnabled);
  e.target.textContent = fwEnabled ? "花火（開）" : "花火（關）";
  if(fwEnabled) launchRandom();
});

/* iOS unlock */
window.addEventListener('touchstart', ()=>{ if(ctx.state==='suspended') ctx.resume(); }, {once:true});
</script>
</body>
</html>
