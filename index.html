
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>風鈴 · Fūrin (Perf+)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{ --ink:#e6eefc; --accent:#60a5ff; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
    background: radial-gradient(1200px 800px at 70% 10%, #0b1a33 0%, #061227 40%, #020914 100%);
    color: var(--ink); display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  #fireworks{ position: fixed; inset: 0; z-index: 0; pointer-events:none; }
  .app{
    position: relative; z-index: 1;
    width: min(520px, 100vw); height: 100vh;
    background: rgba(5, 10, 20, 0.55);
    backdrop-filter: blur(3px);
    border-radius: 18px;
    display:flex; flex-direction:column; align-items:center;
    padding: env(safe-area-inset-top) 16px calc(10px + env(safe-area-inset-bottom));
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
  }
  .title{ width:100%; text-align:left; font-size:18px; color:#9fb7ff; margin:6px 0 0; }
  .canvas{ position:relative; width:100%; flex:1 1 auto; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .diagramWrap{ width:360px; height:520px; transform-origin: top center; }
  .controls{ width:100%; padding-top:8px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  button{
    flex:1 1 auto; padding:12px 14px; border-radius:14px; border:2px solid var(--accent);
    background:rgba(255,255,255,0.06); color: var(--ink); font-size:16px; font-weight:600;
  }
  button.on{ background: var(--accent); color:#00122a; border-color: var(--accent); }
  .row{ display:flex; width:100%; gap:10px; margin-top:6px; align-items:center; }
  .sliderWrap{ flex: 1 1 auto; display:flex; align-items:center; gap:10px; color:#98a7c9; font-size:14px; }
  input[type="range"]{ width:100%; }
  .note{ width:100%; text-align:center; color:#8fa5d6; font-size:12px; margin-top:4px;}
  .toggle{ border-color:#34d399; color:#bdfae2; }
  .toggle.on{ background:#34d399; color:#01251b; }
  .gust{ border-color:#f59e0b; color:#ffe9bf; }
  .gust.on{ background:#f59e0b; color:#1f1400; }
</style>
</head>
<body>
  <canvas id="fireworks"></canvas>

  <div class="app">
    <div class="title">這個是風鈴</div>
    <div class="canvas" id="canvas">
      <!-- Keep the previous SVG diagram and wind logic exactly the same as the last version -->
      <svg id="diagram" class="diagramWrap" viewBox="0 0 360 520" xmlns="http://www.w3.org/2000/svg" aria-label="flow and furin">
        <defs>
          <linearGradient id="frameStroke" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#88b4ff"/><stop offset="100%" stop-color="#3b82f6"/>
          </linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#001a3a" flood-opacity="0.7"/>
          </filter>
          <radialGradient id="glassGrad" cx="50%" cy="40%" r="60%">
            <stop offset="0%" stop-color="#cfe8ff" stop-opacity="0.95"/>
            <stop offset="60%" stop-color="#9ec9ff" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#4aa0ff" stop-opacity="0.18"/>
          </radialGradient>
          <linearGradient id="rimGrad" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#8fb9ff"/><stop offset="100%" stop-color="#4a98ff"/>
          </linearGradient>
        </defs>
        <g transform="translate(180,120) rotate(45) translate(-85,-85)" filter="url(#softShadow)">
          <rect x="0" y="0" width="170" height="170" rx="22" ry="22" fill="#0b1a33" stroke="url(#frameStroke)" stroke-width="6"/>
        </g>
        <text x="180" y="120" text-anchor="middle" dominant-baseline="middle" font-size="20" font-weight="700" fill="#cfe0ff">風有在吹嗎？</text>

        <g id="assembly" transform="rotate(0 180 220)">
          <text x="205" y="220" fill="#a7b4d9" font-size="16">yes</text>
          <line x1="180" y1="200" x2="180" y2="220" stroke="#9fb7ff" stroke-width="3"/>
          <line x1="180" y1="220" x2="180" y2="240" stroke="#9fb7ff" stroke-width="3"/>
          <g id="bellGroup">
            <path d="M130,300 Q180,230 230,300 L230,330 Q180,350 130,330 Z" fill="url(#glassGrad)" stroke="#8db2ff" stroke-width="2"/>
            <ellipse cx="180" cy="300" rx="50" ry="10" fill="url(#rimGrad)" opacity="0.95"/>
            <line id="clapperLine" x1="180" y1="300" x2="180" y2="352" stroke="#9fb7ff" stroke-width="2"/>
            <circle id="clapper" cx="180" cy="360" r="10" fill="#c2d2ff" stroke="#8498cc"/>
          </g>
          <g id="tanzakuGroup">
            <line x1="180" y1="370" x2="180" y2="380" stroke="#9fb7ff" stroke-width="2"/>
            <rect x="165" y="380" width="30" height="70" rx="4" fill="#0f1c33" stroke="#324b7a" />
            <path d="M170 410 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <path d="M170 425 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <text id="tztext" x="180" y="385" text-anchor="middle" fill="#b7d0ff" font-size="14"
                  style="font-family:'Hiragino Sans','PingFang SC',sans-serif; writing-mode:vertical-rl; text-orientation:upright;">
              香橙布叮铃铃
            </text>
          </g>
        </g>
      </svg>
    </div>

    <div class="controls">
      <button id="toggle">有風（開始）</button>
      <button id="one">只響一下</button>
      <button id="gustBtn" class="gust">陣風（關）</button>
      <button id="ambience" class="toggle on">海浪聲（開）</button>
      <button id="fireBtn" class="toggle on">花火（開）</button>
    </div>
    <div class="row">
      <div class="sliderWrap">
        <span>風速</span>
        <input id="rate" type="range" min="0" max="100" value="40">
      </div>
      <div id="status" style="min-width:92px; text-align:right; color:#a9befe; font-size:14px;">待機中</div>
    </div>
    <div class="note">性能加强：粒子精灵绘制、限制 DPR、自适应降载；卡顿明显下降。</div>
  </div>

<script>
/* ---------- Responsive scale (same) ---------- */
function fitDiagram(){
  const baseW = 360, baseH = 520;
  const container = document.getElementById('canvas');
  const target = document.getElementById('diagram');
  const w = container.clientWidth, h = container.clientHeight;
  const scale = Math.min(w/baseW, h/baseH);
  target.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', fitDiagram);
window.addEventListener('orientationchange', ()=>setTimeout(fitDiagram, 200));
setTimeout(fitDiagram, 0);

/* ---------- WebAudio & wind logic (unchanged from gust version) ---------- */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let windTimer=null, running=false;

function chime(){
  const now = ctx.currentTime;
  function bellTone(freq, t){
    const o = ctx.createOscillator(); const m = ctx.createOscillator();
    const g = ctx.createGain(); const mg = ctx.createGain(); const out = ctx.createGain();
    o.type="sine"; o.frequency.value=freq; m.type="sine"; m.frequency.value=freq*1.5; mg.gain.value=400;
    g.gain.setValueAtTime(0, now+t); g.gain.linearRampToValueAtTime(0.9, now+t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+t+1.6);
    out.gain.value=0.55; m.connect(mg); mg.connect(o.frequency); o.connect(g).connect(out).connect(ctx.destination);
    o.start(now+t); m.start(now+t); o.stop(now+t+1.7); m.stop(now+t+1.7);
  }
  bellTone(1400, 0.00); bellTone(1000, 0.05); bellTone(1800, 0.18);
  addImpulse();
}

let rafId = null, phase = 0, impulse = 0;
function addImpulse(extra=0){ const rate = +document.getElementById('rate').value; impulse = Math.max(impulse, 6 + rate/10 + extra); }
function windSwayLoop(){
  const rate = +document.getElementById('rate').value;
  const freq = 0.6 + rate/120, baseAmp = 1 + rate/30;
  phase += (freq*2*Math.PI)/60; impulse *= 0.94; const deg = Math.sin(phase)*(baseAmp+impulse);
  const asm=document.getElementById('assembly'); asm.setAttribute('transform', `rotate(${deg} 180 220)`);
  const bell=document.getElementById('bellGroup'), tz=document.getElementById('tanzakuGroup'), clap=document.getElementById('clapper');
  bell.setAttribute('transform', `rotate(${deg*0.2} 180 300)`); tz.setAttribute('transform', `rotate(${deg*0.4} 180 370)`); clap.setAttribute('transform', `rotate(${deg*0.3} 180 300)`);
  rafId = requestAnimationFrame(windSwayLoop);
}

let gustEnabled=false, gustTimer=null;
function scheduleGust(){
  if(!gustEnabled || !running) return;
  const nextIn = 1200 + Math.random()*5000;
  gustTimer = setTimeout(()=>{
    const bursts = 1 + Math.floor(Math.random()*3);
    const kick = 8 + Math.random()*8; addImpulse(kick); chime();
    let i=1; function more(){ if(i>=bursts) return scheduleGust(); addImpulse(kick*(0.7**i)); chime(); i++; setTimeout(more, 220+Math.random()*280); }
    setTimeout(more, 220+Math.random()*280);
  }, nextIn);
}
function toggleGust(){
  gustEnabled = !gustEnabled;
  const btn = document.getElementById('gustBtn'); btn.classList.toggle('on', gustEnabled); btn.textContent = gustEnabled ? "陣風（開）" : "陣風（關）";
  if(gustEnabled) scheduleGust(); else if(gustTimer){ clearTimeout(gustTimer); gustTimer=null; }
}
document.getElementById('gustBtn').addEventListener('click', toggleGust);

function startWind(){ if(running) return; running=true; document.getElementById('toggle').classList.add('on'); document.getElementById('toggle').textContent='停風（停止）'; document.getElementById('status').textContent='風在吹：響鈴中…'; if(!rafId) rafId=requestAnimationFrame(windSwayLoop); scheduleLoop(); scheduleGust(); }
function stopWind(){ running=false; document.getElementById('toggle').classList.remove('on'); document.getElementById('toggle').textContent='有風（開始）'; document.getElementById('status').textContent='待機中'; clearTimeout(windTimer); windTimer=null; if(gustTimer){clearTimeout(gustTimer);gustTimer=null;} if(rafId){cancelAnimationFrame(rafId); rafId=null;} document.getElementById('assembly').setAttribute('transform','rotate(0 180 220)'); document.getElementById('bellGroup').setAttribute('transform','rotate(0 180 300)'); document.getElementById('tanzakuGroup').setAttribute('transform','rotate(0 180 370)'); document.getElementById('clapper').setAttribute('transform','rotate(0 180 300)'); }
function scheduleLoop(){ const rate=+document.getElementById('rate').value; const baseMs=2000-rate*15; const jitter=Math.random()*600; windTimer=setTimeout(()=>{ chime(); if(running) scheduleLoop(); }, Math.max(300, baseMs + jitter)); }
document.getElementById('toggle').addEventListener('click', ()=>{ if(ctx.state==='suspended') ctx.resume(); running?stopWind():startWind(); });
document.getElementById('one').addEventListener('click', ()=>{ if(ctx.state==='suspended') ctx.resume(); chime(); if(!running){ addImpulse(); if(!rafId){ let frames=0; function tempLoop(){ windSwayLoop(); frames++; if(frames>90){ cancelAnimationFrame(rafId); rafId=null; stopWind(); } } requestAnimationFrame(tempLoop); } } });
document.getElementById('rate').addEventListener('input', ()=>{});

/* ---------- Ocean ambience (same) ---------- */
const ctx2 = ctx;
let ocean = { started:false, gain:null };
function ensureOcean(){ if(!ocean.started){ const noise=ctx2.createScriptProcessor(2048,1,1); const filter=ctx2.createBiquadFilter(); const g=ctx2.createGain(); const lfo=ctx2.createOscillator(); const lfoGain=ctx2.createGain();
  let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; noise.onaudioprocess=function(e){ const out=e.outputBuffer.getChannelData(0); for(let i=0;i<out.length;i++){ const white=Math.random()*2-1;
    b0=0.99886*b0+white*0.0555179; b1=0.99332*b1+white*0.0750759; b2=0.96900*b2+white*0.1538520; b3=0.86650*b3+white*0.3104856; b4=0.55000*b4+white*0.5329522; b5=-0.7616*b5-white*0.0168980;
    out[i]=(b0+b1+b2+b3+b4+b5+b6 + white*0.5362)*0.08; b6=white*0.115926; } }; filter.type="lowpass"; filter.frequency.value=700; g.gain.value=0.25; lfo.frequency.value=0.08; lfoGain.gain.value=0.35;
  lfo.connect(lfoGain); lfoGain.connect(g.gain); noise.connect(filter).connect(g).connect(ctx2.destination); lfo.start(); ocean={started:true, gain:g}; } }
ensureOcean();
document.getElementById('ambience').addEventListener('click', ()=>{ ensureOcean(); const btn=document.getElementById('ambience'); if(btn.classList.contains('on')){ ocean.gain.gain.cancelScheduledValues(ctx.currentTime); ocean.gain.gain.linearRampToValueAtTime(0.0, ctx.currentTime + 0.6); btn.classList.remove('on'); btn.textContent="海浪聲（關）"; } else { if(ctx.state==='suspended') ctx.resume(); ocean.gain.gain.cancelScheduledValues(ctx.currentTime); ocean.gain.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.8); btn.classList.add('on'); btn.textContent="海浪聲（開）"; } });

/* ---------- Performance-optimized Fireworks ---------- */
(function(){
  const canvas = document.getElementById('fireworks');
  const ctx = canvas.getContext('2d', {alpha:true});

  // 1) Cap device pixel ratio to cut fill rate
  const DPR = Math.min(window.devicePixelRatio || 1, 1.5);
  function resize(){
    canvas.width = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0); // scale drawing back to CSS pixels
  }
  window.addEventListener('resize', resize); resize();

  // 2) Draw particles using a pre-rendered radial gradient sprite
  const sprite = document.createElement('canvas');
  const S = 32; sprite.width = sprite.height = S;
  const g = sprite.getContext('2d');
  const grad = g.createRadialGradient(S/2,S/2,1, S/2,S/2,S/2);
  grad.addColorStop(0,'rgba(255,255,255,1)');
  grad.addColorStop(0.4,'rgba(255,255,255,0.8)');
  grad.addColorStop(1,'rgba(255,255,255,0)');
  g.fillStyle = grad; g.beginPath(); g.arc(S/2,S/2,S/2,0,Math.PI*2); g.fill();

  // 3) Particle pool to avoid GC thrash
  const MAX_PARTICLES = 800; // global cap
  const pool = new Array(MAX_PARTICLES).fill(null).map(()=>({active:false}));
  const parts = []; // active list view
  function getP(){ for(let i=0;i<pool.length;i++){ if(!pool[i].active){ pool[i].active=true; parts.push(pool[i]); return pool[i]; } } return null; }
  function freeP(p){ p.active=false; const idx=parts.indexOf(p); if(idx>-1) parts.splice(idx,1); }

  // 4) Adaptive load controller (reduce particles when FPS drops)
  let lastT = performance.now(); let fpsEMA = 60;
  function updateFPS(){
    const now = performance.now(); const dt = now-lastT; lastT=now; const fps = 1000/dt; fpsEMA = fpsEMA*0.9 + fps*0.1;
  }
  function particlesPerBurst(){
    // 60fps -> 70~90; 30fps -> 35~45
    const base = (fpsEMA>=55) ? 90 : (fpsEMA>=45) ? 70 : (fpsEMA>=35) ? 55 : 40;
    return Math.min(base, Math.floor(MAX_PARTICLES - parts.length) );
  }

  function burst(x,y,color){
    const n = Math.max(20, particlesPerBurst());
    for(let i=0;i<n;i++){
      const p = getP(); if(!p) break;
      const angle = Math.random()*Math.PI*2;
      const speed = (Math.random()*2.2)+1.2; // lower speed for longer life
      p.x=x; p.y=y;
      p.vx = Math.cos(angle)*speed; p.vy = Math.sin(angle)*speed;
      p.life = 60 + Math.random()*70;
      p.alpha = 1;
      p.size = 1.2 + Math.random()*2.2;
      p.color = color;
    }
  }

  function launchRandom(){
    if(!fwEnabled) return; // hooked to outer toggle
    const x = Math.random()*canvas.width/DPR*0.7 + canvas.width/DPR*0.15;
    const y = Math.random()*canvas.height/DPR*0.35 + canvas.height/DPR*0.15;
    const colors = ["#ffd166","#ff6a6a","#86e2ff","#b794f4","#78e08f","#f6a9d6","#fff5a3"];
    burst(x,y, colors[Math.random()*colors.length|0]);
    setTimeout(launchRandom, 700 + Math.random()*900);
  }
  launchRandom();

  // 5) Single composite mode switch (lighter) and sprite blits
  function step(){
    updateFPS();
    ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
    ctx.globalCompositeOperation = 'lighter';

    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      // integrate
      p.x += p.vx; p.y += p.vy; p.vy += 0.02;
      p.life -= 1; p.alpha = p.life/80;
      if(p.alpha<=0){ freeP(p); continue; }

      ctx.globalAlpha = Math.max(0, Math.min(1, p.alpha));
      ctx.save();
      ctx.translate(p.x, p.y);
      // tint sprite by drawing a colored rectangle behind, then sprite
      ctx.fillStyle = p.color;
      // Draw colored sprite by using composite trick
      ctx.drawImage(sprite, -p.size*2, -p.size*2, p.size*4, p.size*4);
      ctx.restore();
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();

/* ---------- Fireworks toggle wired to fwEnabled ---------- */
let fwEnabled = true;
document.getElementById('fireBtn').addEventListener('click', (e)=>{
  fwEnabled = !fwEnabled;
  e.target.classList.toggle('on', fwEnabled);
  e.target.textContent = fwEnabled ? "花火（開）" : "花火（關）";
});

/* ---------- iOS unlock ---------- */
window.addEventListener('touchstart', ()=>{ if(ctx.state==='suspended') ctx.resume(); }, {once:true});
</script>
</body>
</html>
