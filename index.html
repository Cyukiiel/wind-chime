<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>風鈴 · 夏日祭 v23.3（整合终版）</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{ --ink:#e6eefc; --accent:#60a5ff; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; }
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans","Noto Sans CJK SC",sans-serif;
    background: radial-gradient(1400px 900px at 70% 10%, #0a1830 0%, #08162b 35%, #051224 70%, #020a18 100%);
    color:var(--ink); display:flex; align-items:center; justify-content:center; overflow:auto;
    -webkit-overflow-scrolling:touch; padding-top:calc(8px + env(safe-area-inset-top));
  }
  #fw{ position:fixed; inset:0; z-index:0; pointer-events:none!important; }
  .app{ position:relative; z-index:1; width:min(540px,100vw); min-height:calc(100vh - env(safe-area-inset-top));
        background:rgba(5,10,20,.55); backdrop-filter:blur(4px); border-radius:18px; display:flex; flex-direction:column; align-items:center;
        padding:14px 16px calc(18px + env(safe-area-inset-bottom)); box-shadow:0 12px 40px rgba(0,0,0,.35);}
  .title{ width:100%; text-align:left; font-size:18px; color:#a7c4ff; margin:2px 0 0;}
  .canvas{ position:relative; width:100%; flex:1 1 auto; overflow:hidden; display:flex; align-items:center; justify-content:center;}
  .diagramWrap{ width:360px; height:520px; transform-origin: top center; }
  .controls{ position:relative; z-index:20; width:100%; padding-top:8px; display:flex; gap:10px; flex-wrap:wrap;}
  button{ flex:1 1 auto; padding:12px 14px; border-radius:14px; border:2px solid var(--accent);
          background:rgba(255,255,255,.07); color:var(--ink); font-size:16px; font-weight:600; }
  button.on{ background:var(--accent); color:#00122a; border-color:var(--accent); }
  .toggle{ border-color:#34d399; color:#bdfae2;} .toggle.on{ background:#34d399; color:#01251b;}
  .gust{ border-color:#f59e0b; color:#ffe9bf;} .gust.on{ background:#f59e0b; color:#1f1400;}
  .festival{ border-color:#ef4444; color:#ffdada;} .festival.on{ background:#ef4444; color:#2c0000;}
  .lively{ border-color:#a78bfa; color:#efe7ff;} .lively.on{ background:#a78bfa; color:#1f0c4f;}
  .row{ display:flex; width:100%; gap:10px; margin-top:6px; align-items:center;}
  .sliderWrap{ flex:1 1 auto; display:flex; align-items:center; gap:10px; color:#98a7c9; font-size:14px;}
  input[type=range]{ width:100%; }
  .note{ width:100%; text-align:center; color:#8fa5d6; font-size:12px; margin-top:4px;}
  #toast{ position:fixed; left:50%; bottom:calc(14px + env(safe-area-inset-bottom)); transform:translateX(-50%);
          background:rgba(0,0,0,.7); color:#fff; padding:10px 14px; border-radius:14px; opacity:0; pointer-events:none; transition:opacity .25s;}
  #toast.show{ opacity:1; }
  #dot{ position:fixed; right:10px; bottom:10px; width:14px; height:14px; border-radius:50%; z-index:22; background:#f33; box-shadow:0 0 0 2px rgba(0,0,0,.25); }
  #dot.mid{ background:#f59e0b; }   /* 橙：初始化中 */
  #dot.ok{ background:#22c55e; }    /* 绿：已就绪 */
  #dot.flash{ box-shadow:0 0 0 6px rgba(255,255,255,.6); transition: box-shadow .18s; }
</style>
</head>
<body>
  <div id="toast"></div>
  <div id="dot" title="status"></div>
  <canvas id="fw"></canvas>

  <div class="app">
    <div class="title">日本夏日祭 · 風鈴</div>
    <div class="canvas" id="canvas">
      <svg id="diagram" class="diagramWrap" viewBox="0 0 360 520" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="frameStroke" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#88b4ff"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#001a3a" flood-opacity="0.7"/></filter>
          <radialGradient id="glassGrad" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#cfe8ff" stop-opacity="0.95"/><stop offset="60%" stop-color="#9ec9ff" stop-opacity="0.38"/><stop offset="100%" stop-color="#4aa0ff" stop-opacity="0.18"/></radialGradient>
          <linearGradient id="rimGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#8fb9ff"/><stop offset="100%" stop-color="#4a98ff"/></linearGradient>
        </defs>
        <g transform="translate(180,120) rotate(45) translate(-85,-85)" filter="url(#softShadow)">
          <rect x="0" y="0" width="170" height="170" rx="22" ry="22" fill="#0b1a33" stroke="url(#frameStroke)" stroke-width="6"/>
        </g>
        <text x="180" y="120" text-anchor="middle" dominant-baseline="middle" font-size="20" font-weight="700" fill="#cfe0ff">風有在吹嗎？</text>

        <g id="assembly" transform="rotate(0 180 220)">
          <text x="205" y="220" fill="#a7b4d9" font-size="16">yes</text>
          <line x1="180" y1="200" x2="180" y2="240" stroke="#9fb7ff" stroke-width="3"/>
          <g id="bellGroup">
            <path d="M130,300 Q180,230 230,300 L230,330 Q180,350 130,330 Z" fill="url(#glassGrad)" stroke="#8db2ff" stroke-width="2"/>
            <ellipse cx="180" cy="300" rx="50" ry="10" fill="url(#rimGrad)" opacity="0.95"/>
            <line id="clapperLine" x1="180" y1="300" x2="180" y2="364" stroke="#aecdff" stroke-width="2"/>
            <circle id="clapper" cx="180" cy="372" r="10" fill="#c2d2ff" stroke="#8498cc"/>
          </g>
          <g id="tanzakuGroup">
            <line x1="180" y1="382" x2="180" y2="392" stroke="#9fb7ff" stroke-width="2"/>
            <rect x="165" y="392" width="30" height="70" rx="4" fill="#0f1c33" stroke="#324b7a" />
            <text x="180" y="397" text-anchor="middle" fill="#b7d0ff" font-size="14" style="font-family:'Hiragino Sans','PingFang SC',sans-serif; writing-mode:vertical-rl;">香橙布叮铃铃</text>
          </g>
        </g>
      </svg>
    </div>

    <div class="controls">
      <button id="btnToggle"  onclick="App.toggle()"  ontouchend="App.toggle()">有風（開始）</button>
      <button id="btnOne"     onclick="App.one()"     ontouchend="App.one()">只響一下</button>
      <button id="btnGust"    onclick="App.gust()"    ontouchend="App.gust()" class="gust">陣風（關）</button>
      <button id="btnSea"     onclick="App.sea()"     ontouchend="App.sea()"  class="toggle on">海浪聲（開）</button>
      <button id="btnHanabi"  onclick="App.hanabi()"  ontouchend="App.hanabi()" class="festival on">花火大会（開）</button>
      <button id="btnLively"  onclick="App.lively()"  ontouchend="App.lively()" class="lively on">灵动（开）</button>
    </div>
    <div class="row">
      <div class="sliderWrap"><span>風速</span><input id="rate" type="range" min="0" max="100" value="45" oninput="App.rate()"></div>
      <div id="status" style="min-width:92px; text-align:right; color:#a9befe; font-size:14px;">待機中</div>
    </div>
    <div class="note">v23.3：按钮排队 + 交互后初始化音频/花火；红=未就绪 / 橙=加载中 / 绿=已就绪。</div>
  </div>

<script>
/* 0) 占位 App：排队兜底，防未就绪点击丢失 */
(function(){
  const q=[]; const t=document.getElementById('toast'); const dot=document.getElementById('dot');
  dot.classList.add('mid'); // 橙
  const toast=msg=>{ t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),700); };
  const call=name=>{ q.push(name); toast('加载中…已排队 '+q.length); };
  window.App={ _queue:q, _ready:false,
    toggle:()=>call('toggle'), one:()=>call('one'), gust:()=>call('gust'),
    sea:()=>call('sea'), hanabi:()=>call('hanabi'), lively:()=>call('lively'), rate:()=>call('rate')
  };
})();

/* 1) 真正的 App */
const App = (()=>{
  const Toast=(t=>{const el=document.getElementById('toast'); return msg=>{ el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),900);} })();
  const Dot=(()=>{const d=document.getElementById('dot'); return ()=>{ d.classList.add('ok'); d.classList.remove('mid'); d.classList.add('flash'); setTimeout(()=>d.classList.remove('flash'),180);} })();

  // 自适应缩放
  (function(){ const baseW=360, baseH=520, container=document.getElementById('canvas'), target=document.getElementById('diagram');
    function fit(){ const w=container.clientWidth||baseW, h=container.clientHeight||baseH; target.style.transform='scale('+Math.min(w/baseW,h/baseH)+')'; }
    addEventListener('resize', fit); setTimeout(fit, 0);
  })();

  const $=id=>document.getElementById(id);
  const assembly=$('assembly'), bellGroup=$('bellGroup'), tanzakuGroup=$('tanzakuGroup'), clapper=$('clapper');
  const status=$('status'); const btnToggle=$('btnToggle'), btnGust=$('btnGust'), btnSea=$('btnSea'), btnHanabi=$('btnHanabi'), btnLively=$('btnLively');
  const rateEl=$('rate');

  /* 音频 */
  let audioCtx=null, oceanGain=null;
  function ensureAudio(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); window.__audio=audioCtx; }
  function chime(){ ensureAudio(); const now=audioCtx.currentTime;
    function bellTone(f,t,g){const o=audioCtx.createOscillator(),m=audioCtx.createOscillator(),G=audioCtx.createGain(),MG=audioCtx.createGain(),out=audioCtx.createGain();
      o.type='sine'; o.frequency.value=f; m.type='sine'; m.frequency.value=f*1.5; MG.gain.value=400;
      G.gain.setValueAtTime(0,now+t); G.gain.linearRampToValueAtTime(0.9,now+t+.01); G.gain.exponentialRampToValueAtTime(.0001,now+t+1.6);
      out.gain.value=g||.55; m.connect(MG); MG.connect(o.frequency); o.connect(G).connect(out).connect(audioCtx.destination);
      o.start(now+t); m.start(now+t); o.stop(now+t+1.7); m.stop(now+t+1.7);
    }
    bellTone(1400,0,.55); bellTone(1000,0.05,.45); bellTone(1800,0.18,.5); addKickDeg(85);
  }
  function ensureSea(){ if(oceanGain) return; ensureAudio();
    const ctx=audioCtx, n=ctx.createScriptProcessor(2048,1,1), f=ctx.createBiquadFilter(), g=ctx.createGain(), lfo=ctx.createOscillator(), lg=ctx.createGain();
    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    n.onaudioprocess=e=>{ const out=e.outputBuffer.getChannelData(0); for(let i=0;i<out.length;i++){ const w=Math.random()*2-1;
      b0=0.99886*b0+w*0.0555179; b1=0.99332*b1+w*0.0750759; b2=0.96900*b2+w*0.1538520; b3=0.86650*b3+w*0.3104856; b4=0.55000*b4+w*0.5329522; b5=-0.7616*b5-w*0.0168980; out[i]=(b0+b1+b2+b3+b4+b5+b6 + w*0.5362)*0.08; b6=w*0.115926; } };
    f.type='lowpass'; f.frequency.value=700; g.gain.value=0.22; lfo.frequency.value=0.09; lg.gain.value=0.35; lfo.connect(lg); lg.connect(g.gain); n.connect(f).connect(g).connect(ctx.destination); lfo.start();
    oceanGain=g;
  }

  /* 物理（阻尼摆 + 低通跟随） */
  let raf=null, running=false, windTimer=null, gustEnabled=false;
  let theta=0, omega=0, lastTS=0, phase=0;
  let params={T:2.2,zeta:0.10,driveK:0.75,deadbandDeg:0.35,micro:0.7};
  function addKickDeg(d){ omega += (d||60)*Math.PI/180; }
  function step(ts){
    if(!lastTS) lastTS=ts; const dt=Math.min(0.05,(ts-lastTS)/1000); lastTS=ts;
    const wn=2*Math.PI/params.T, zeta=params.zeta + (+rateEl.value)/1200;
    phase += 2*Math.PI*(.28 + (+rateEl.value)/380)*dt;
    const drive=(5+(+rateEl.value)*.10)*Math.PI/180*Math.sin(phase) + (Math.random()*2-1)*params.micro*Math.PI/180;
    const alpha=-2*zeta*wn*omega - wn*wn*theta + drive*wn*wn*params.driveK;
    omega += alpha*dt; const C=8; if(omega>C) omega=C; else if(omega<-C) omega=-C;
    theta += omega*dt;
    const db=params.deadbandDeg*Math.PI/180;
    if(!running && Math.abs(theta)<db && Math.abs(omega)<db){
      theta=0; omega=0; if(raf){ cancelAnimationFrame(raf); raf=null; }
      assembly.setAttribute('transform','rotate(0 180 220)'); bellGroup.removeAttribute('transform'); tanzakuGroup.removeAttribute('transform'); clapper.removeAttribute('transform');
      status.textContent='待機中'; return;
    }
    const deg=theta*180/Math.PI, lpf=(v,t,s,dt)=> v+(t-v)*(1-Math.exp(-s*dt));
    assembly.setAttribute('transform','rotate('+deg+' 180 220)');
    bellGroup.setAttribute('transform','rotate('+lpf(0,deg*.22,7,dt)+' 180 300)');
    tanzakuGroup.setAttribute('transform','rotate('+lpf(0,deg*.42,4.2,dt)+' 180 392)');
    clapper.setAttribute('transform','rotate('+lpf(0,deg*.30,8.5,dt)+' 180 300)');
    raf=requestAnimationFrame(step);
  }
  function loopChime(){ const r=+rateEl.value, base=2000-r*15, jitter=Math.random()*600; windTimer=setTimeout(()=>{ try{ chime(); }catch{} if(running) loopChime(); }, Math.max(300,base+jitter)); }
  function loopGust(){ if(!gustEnabled||!running) return; const next=1000+Math.random()*5000; setTimeout(()=>{ const bursts=1+Math.floor(Math.random()*3); const k=8+Math.random()*8; addKickDeg(k*6); chime(); let i=1;(function more(){ if(i>=bursts) return loopGust(); addKickDeg(k*6*(0.7**i)); chime(); i++; setTimeout(more,200+Math.random()*300); })(); }, next); }

  /* 花火（轻量尾迹版） */
  let hanabiBooted=false, hanabiEnabled=true;
  function bootHanabi(){
    if(hanabiBooted) return; hanabiBooted=true;
    const cvs=document.getElementById('fw'), ctx=cvs.getContext('2d',{alpha:true});
    const DPR=Math.min(window.devicePixelRatio||1,1.5);
    function resize(){ cvs.width=Math.floor(innerWidth*DPR); cvs.height=Math.floor(innerHeight*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
    resize(); addEventListener('resize', resize);
    const S=36, sprite=document.createElement('canvas'); sprite.width=sprite.height=S;
    const sg=sprite.getContext('2d'); const grad=sg.createRadialGradient(S/2,S/2,0, S/2,S/2,S/2);
    grad.addColorStop(0,'rgba(255,255,255,1)'); grad.addColorStop(0.25,'rgba(255,255,255,0.85)'); grad.addColorStop(1,'rgba(255,255,255,0)'); sg.fillStyle=grad; sg.beginPath(); sg.arc(S/2,S/2,S/2,0,6.283); sg.fill();
    const palettes=[["#ff9aa2","#ffd1dc","#fff5ba"],["#a0e7e5","#b4f8c8","#fbe7c6"],["#cdb4db","#ffc8dd","#ffe5ec"],["#90dbf4","#a3c4f3","#fde4cf"]];
    const parts=[], shells=[];
    function part(){ const p={x:0,y:0,vx:0,vy:0,g:0,life:100,size:2.2,c:"#fff",alpha:1,tail:[]}; parts.push(p); return p; }
    function shell(){ const s={x:0,y:0,vx:0,vy:0,type:"ring",colors:palettes[0],h:innerHeight*.3,t:0}; shells.push(s); return s; }
    function launch(x){ if(!hanabiEnabled) return; const s=shell(); const W=innerWidth,H=innerHeight; s.x=(x==null)?(W*.2+Math.random()*W*.6):x; s.y=H+20; s.vx=(Math.random()*2-1)*.4; s.vy=-(7+Math.random()*3); s.type=["kiku","peony","ring","willow"][Math.random()*4|0]; s.colors=palettes[Math.random()*palettes.length|0]; s.h=H*(.25+Math.random()*.25); s.t=0; }
    function burst(x,y,type,colors){ const base=110, pick=()=>colors[Math.random()*colors.length|0]; const push=(vx,vy,g,life,size,c)=>{ const p=part(); p.x=x;p.y=y;p.vx=vx;p.vy=vy;p.g=g;p.life=life;p.size=size;p.c=c;p.alpha=1;p.tail=[]; };
      if(type==="ring"){ for(let i=0;i<base;i++){ const a=i/base*6.283; push(Math.cos(a)*2.2,Math.sin(a)*2.2,.018,90,2.2,pick()); } }
      else if(type==="kiku"){ for(let i=0;i<base;i++){ const a=i/base*6.283+(Math.random()-.5)*.02, k=1+Math.sin(8*a)*.15; push(Math.cos(a)*2.6*k,Math.sin(a)*2.6*k,.017,100,2.4,pick()); } }
      else if(type==="willow"){ for(let i=0;i<base*.9;i++){ const a=Math.random()*6.283; push(Math.cos(a)*1.6,Math.sin(a)*1.2,.034,120,2.2,"#ffdca8"); } }
      else { for(let i=0;i<base;i++){ const a=Math.random()*6.283; push(Math.cos(a)*2.3,Math.sin(a)*2.3,.018,95,2.2,pick()); } for(let i=0;i<base*.12;i++){ const a=Math.random()*6.283; push(Math.cos(a)*.9,Math.sin(a)*.9,.02,70,1.6,pick()); } }
    }
    function tail(p){ p.tail.push([p.x,p.y]); if(p.tail.length>8) p.tail.shift(); ctx.lineWidth=1; ctx.globalAlpha=.25*Math.max(p.alpha,0); ctx.strokeStyle=p.c; ctx.beginPath(); for(let i=0;i<p.tail.length;i++){ const [tx,ty]=p.tail[i]; if(i===0) ctx.moveTo(tx,ty); else ctx.lineTo(tx,ty);} ctx.stroke(); ctx.globalAlpha=1; }
    function loop(){ const DPR=Math.min(window.devicePixelRatio||1,1.5), W=cvs.width/DPR, H=cvs.height/DPR;
      ctx.clearRect(0,0,W,H); ctx.globalCompositeOperation='lighter';
      for(let i=shells.length-1;i>=0;i--){ const s=shells[i]; s.x+=s.vx; s.y+=s.vy; s.vy+=.06; s.t+=16; if(s.t>30){ const p=part(); p.x=s.x; p.y=s.y; p.vx=(Math.random()*2-1)*.2; p.vy=(Math.random()*2-1)*.2; p.g=0; p.life=22; p.size=1.6; p.c=s.colors[0]; p.alpha=.8; p.tail=[]; s.t=0;} ctx.drawImage(sprite, s.x-2, s.y-6, 4, 12); if(s.vy>0 || s.y < s.h){ burst(s.x,s.y,s.type,s.colors); shells.splice(i,1);} }
      for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.life--; p.alpha=p.life/95; tail(p); if(p.alpha<=0){ parts.splice(i,1); continue; } ctx.globalAlpha=Math.max(0,Math.min(1,p.alpha)); ctx.drawImage(sprite, p.x-p.size*2, p.y-p.size*2, p.size*4, p.size*4); ctx.globalAlpha=1; }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
    setTimeout(()=>{ launch(innerWidth*.3); launch(innerWidth*.5); launch(innerWidth*.7); },800);
    (function auto(){ if(hanabiEnabled){ launch(); } setTimeout(auto, 900+Math.random()*900); })();
  }

  /* Public API */
  function ensureBoot(){ Dot(); Toast('按钮已触发'); if(!audioCtx) ensureAudio(); if(!hanabiBooted) bootHanabi(); }
  return {
    toggle(){ ensureBoot(); if(audioCtx.state==='suspended') audioCtx.resume();
      if(running){ running=false; btnToggle.classList.remove('on'); btnToggle.textContent='有風（開始）'; status.textContent='待機中'; clearTimeout(windTimer); }
      else{ running=true; btnToggle.classList.add('on'); btnToggle.textContent='停風（停止）'; status.textContent='風在吹：響鈴中…'; if(!raf){ lastTS=0; raf=requestAnimationFrame(step);} loopChime(); }
    },
    one(){ ensureBoot(); chime(); if(!running){ if(!raf){ lastTS=0; raf=requestAnimationFrame(step); } } },
    gust(){ ensureBoot(); gustEnabled=!gustEnabled; btnGust.classList.toggle('on',gustEnabled); btnGust.textContent=gustEnabled?'陣風（開）':'陣風（關）'; if(gustEnabled) loopGust(); },
    sea(){ ensureBoot(); ensureSea();
      if(btnSea.classList.contains('on')){ oceanGain.gain.cancelScheduledValues(audioCtx.currentTime); oceanGain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime+0.6); btnSea.classList.remove('on'); btnSea.textContent='海浪聲（關）'; }
      else{ oceanGain.gain.cancelScheduledValues(audioCtx.currentTime); oceanGain.gain.linearRampToValueAtTime(0.22, audioCtx.currentTime+0.8); btnSea.classList.add('on'); btnSea.textContent='海浪聲（開）'; }
    },
    hanabi(){ ensureBoot(); hanabiEnabled=!hanabiEnabled; btnHanabi.classList.toggle('on',hanabiEnabled); btnHanabi.textContent=hanabiEnabled?'花火大会（開）':'花火大会（關）'; },
    lively(){ ensureBoot(); const on=!btnLively.classList.contains('on'); btnLively.classList.toggle('on',on); btnLively.textContent= on?'灵动（开）':'灵动（关）';
      params = on?{T:2.2,zeta:0.10,driveK:0.75,deadbandDeg:0.35,micro:0.7}:{T:2.6,zeta:0.14,driveK:0.60,deadbandDeg:0.40,micro:0.2}; },
    rate(){ /* 即调即用 */ }
  };
})();

/* 2) 覆盖占位 App，并回放队列 */
(function adopt(){
  const q = (window.App && window.App._queue) ? window.App._queue.slice(0) : [];
  window.App = App;
  window.App._ready = true;
  const d=document.getElementById('dot'); d.classList.add('ok'); d.classList.remove('mid');
  while(q.length){ const name=q.shift(); try{ if(typeof App[name]==='function') App[name](); }catch(e){} }
})();
</script>
</body>
</html>
