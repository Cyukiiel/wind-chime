
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>風鈴 · 日本夏日祭 v21.3</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root{ --ink:#e6eefc; --accent:#60a5ff; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: rgba(0,0,0,0); }
  html,body{ height:100%; margin:0; }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
    background: radial-gradient(1400px 900px at 70% 10%, #0a1830 0%, #08162b 35%, #051224 70%, #020a18 100%);
    color: var(--ink); display:flex; align-items:center; justify-content:center; overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding-top: calc(8px + env(safe-area-inset-top));
  }
  #hanabi{ position:fixed; inset:0; z-index:0; pointer-events:none; }
  .app{ position: relative; z-index: 1; width:min(540px, 100vw); min-height:calc(100vh - env(safe-area-inset-top));
        background: rgba(5, 10, 20, 0.55); backdrop-filter: blur(4px);
        border-radius: 18px; display:flex; flex-direction:column; align-items:center;
        padding: 14px 16px calc(18px + env(safe-area-inset-bottom));
        box-shadow: 0 12px 40px rgba(0,0,0,.35); pointer-events:auto; }
  .title{ width:100%; text-align:left; font-size:18px; color:#a7c4ff; margin:2px 0 0; }
  .canvas{ position:relative; width:100%; flex:1 1 auto; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .diagramWrap{ width:360px; height:520px; transform-origin: top center; }
  .controls{ width:100%; padding-top:8px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  button{ flex:1 1 auto; padding:12px 14px; border-radius:14px; border:2px solid var(--accent);
          background:rgba(255,255,255,0.07); color: var(--ink); font-size:16px; font-weight:600; cursor:pointer; pointer-events:auto; position:relative; z-index:3; }
  button.on{ background: var(--accent); color:#00122a; border-color: var(--accent); }
  .toggle{ border-color:#34d399; color:#bdfae2; } .toggle.on{ background:#34d399; color:#01251b; }
  .gust{ border-color:#f59e0b; color:#ffe9bf; } .gust.on{ background:#f59e0b; color:#1f1400; }
  .festival{ border-color:#ef4444; color:#ffdada; } .festival.on{ background:#ef4444; color:#2c0000; }
  .lively{ border-color:#a78bfa; color:#efe7ff; } .lively.on{ background:#a78bfa; color:#1f0c4f; }
  .row{ display:flex; width:100%; gap:10px; margin-top:6px; align-items:center; }
  .sliderWrap{ flex: 1 1 auto; display:flex; align-items:center; gap:10px; color:#98a7c9; font-size:14px; }
  input[type="range"]{ width:100%; }
  .note{ width:100%; text-align:center; color:#8fa5d6; font-size:12px; margin-top:4px;}
  #err{ position:fixed; left:8px; right:8px; top:8px; z-index:9; background:#ff3b30; color:#fff; padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.3); font-size:13px; display:none; white-space:pre-wrap; }
  /* 右下角小点：绿=已绑定，红=未绑定；每次按钮触发闪白 */
  #dot{ position:fixed; right:10px; bottom:10px; width:14px; height:14px; border-radius:50%; z-index:10; background:#f33; box-shadow:0 0 0 2px rgba(0,0,0,.25); }
  #dot.ok{ background:#22c55e; }
  #dot.flash{ box-shadow:0 0 0 6px rgba(255,255,255,.6); transition: box-shadow .18s ease; }
</style>
</head>
<body>
  <div id="err"></div>
  <div id="dot" title="init status"></div>
  <canvas id="hanabi"></canvas>

  <div class="app">
    <div class="title">日本夏日祭 · 風鈴</div>
    <div class="canvas" id="canvas">
      <svg id="diagram" class="diagramWrap" viewBox="0 0 360 520" xmlns="http://www.w3.org/2000/svg" aria-label="flow and furin">
        <defs>
          <linearGradient id="frameStroke" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#88b4ff"/><stop offset="100%" stop-color="#3b82f6"/></linearGradient>
          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#001a3a" flood-opacity="0.7"/></filter>
          <radialGradient id="glassGrad" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#cfe8ff" stop-opacity="0.95"/><stop offset="60%" stop-color="#9ec9ff" stop-opacity="0.38"/><stop offset="100%" stop-color="#4aa0ff" stop-opacity="0.18"/></radialGradient>
          <linearGradient id="rimGrad" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#8fb9ff"/><stop offset="100%" stop-color="#4a98ff"/></linearGradient>
        </defs>
        <g transform="translate(180,120) rotate(45) translate(-85,-85)" filter="url(#softShadow)"><rect x="0" y="0" width="170" height="170" rx="22" ry="22" fill="#0b1a33" stroke="url(#frameStroke)" stroke-width="6"/></g>
        <text x="180" y="120" text-anchor="middle" dominant-baseline="middle" font-size="20" font-weight="700" fill="#cfe0ff">風有在吹嗎？</text>
        <g id="assembly" transform="rotate(0 180 220)">
          <text x="205" y="220" fill="#a7b4d9" font-size="16">yes</text>
          <line x1="180" y1="200" x2="180" y2="220" stroke="#9fb7ff" stroke-width="3"/>
          <line x1="180" y1="220" x2="180" y2="240" stroke="#9fb7ff" stroke-width="3"/>
          <g id="bellGroup">
            <path d="M130,300 Q180,230 230,300 L230,330 Q180,350 130,330 Z" fill="url(#glassGrad)" stroke="#8db2ff" stroke-width="2"/>
            <ellipse cx="180" cy="300" rx="50" ry="10" fill="url(#rimGrad)" opacity="0.95"/>
            <line id="clapperLine" x1="180" y1="300" x2="180" y2="364" stroke="#aecdff" stroke-width="2"/>
            <circle id="clapper" cx="180" cy="372" r="10" fill="#c2d2ff" stroke="#8498cc"/>
          </g>
          <g id="tanzakuGroup">
            <line x1="180" y1="382" x2="180" y2="392" stroke="#9fb7ff" stroke-width="2"/>
            <rect x="165" y="392" width="30" height="70" rx="4" fill="#0f1c33" stroke="#324b7a" />
            <path d="M170 420 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <path d="M170 435 q10 -10 20 0" stroke="#3c62a3" fill="none" opacity="0.6"/>
            <text id="tztext" x="180" y="397" text-anchor="middle" fill="#b7d0ff" font-size="14"
                  style="font-family:'Hiragino Sans','PingFang SC',sans-serif; writing-mode:vertical-rl; text-orientation:upright;">香橙布叮铃铃</text>
          </g>
        </g>
      </svg>
    </div>

    <div class="controls">
      <button id="toggle">有風（開始）</button>
      <button id="one">只響一下</button>
      <button id="gustBtn" class="gust">陣風（關）</button>
      <button id="ambience" class="toggle on">海浪聲（開）</button>
      <button id="hanabiBtn" class="festival on">花火大会（開）</button>
      <button id="livelyBtn" class="lively on">灵动（开）</button>
    </div>
    <div class="row">
      <div class="sliderWrap"><span>風速</span><input id="rate" type="range" min="0" max="100" value="45"></div>
      <div id="status" style="min-width:92px; text-align:right; color:#a9befe; font-size:14px;">待機中</div>
    </div>
    <div class="note">v21.3：触控修复 + 安全区顶边 + 右下角状态点（绿=已就绪）。</div>
  </div>

<script>
// Error banner
(function(){
  const box = document.getElementById('err');
  window.addEventListener('error', e=>{ box.style.display='block'; box.textContent='[JS Error] '+(e.message||'')+'\\n'+(e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||''); });
  window.addEventListener('unhandledrejection', e=>{ box.style.display='block'; box.textContent='[Promise Rejection] '+(e.reason&&e.reason.message?e.reason.message:e.reason); });
})();

// iOS unlock
window.addEventListener('touchstart', ()=>{ try{ if(window.__audio && __audio.state==='suspended') __audio.resume(); }catch(e){} }, {passive:true});

function flashDot(){ const d=document.getElementById('dot'); d.classList.add('flash'); setTimeout(()=>d.classList.remove('flash'),180); }

function init(){
  const d=document.getElementById('dot');
  const $=id=>document.getElementById(id);
  const assembly=$('assembly'), bellGroup=$('bellGroup'), tanzakuGroup=$('tanzakuGroup'), clapper=$('clapper');
  const toggle=$('toggle'), one=$('one'), gustBtn=$('gustBtn'), ambience=$('ambience'), hanabiBtn=$('hanabiBtn'), livelyBtn=$('livelyBtn');
  const rate=$('rate'), status=$('status');
  if(!assembly||!toggle||!rate){ return; } // DOM 还没好，等下一个钩子

  // mark ok
  d.classList.add('ok');

  // Audio
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)(); window.__audio=audioCtx;
  function chime(){ const now=audioCtx.currentTime;
    function bellTone(freq,t,gain){const o=audioCtx.createOscillator(),m=audioCtx.createOscillator(),g=audioCtx.createGain(),mg=audioCtx.createGain(),out=audioCtx.createGain();o.type='sine';o.frequency.value=freq;m.type='sine';m.frequency.value=freq*1.5;mg.gain.value=400;g.gain.setValueAtTime(0,now+t);g.gain.linearRampToValueAtTime(0.9,now+t+.01);g.gain.exponentialRampToValueAtTime(.0001,now+t+1.6);out.gain.value=gain||.55;m.connect(mg);mg.connect(o.frequency);o.connect(g).connect(out).connect(audioCtx.destination);o.start(now+t);m.start(now+t);o.stop(now+t+1.7);m.stop(now+t+1.7);}bellTone(1400,0,0.55);bellTone(1000,0.05,0.45);bellTone(1800,0.18,0.5); addKickDeg(85); }

  // Physics
  let raf=null,running=false,windTimer=null,gustEnabled=false,gustTimer=null;
  let theta=0,omega=0,lastTS=0,phase=0;
  let params={T:2.2,zeta:0.10,driveK:0.75,deadbandDeg:0.35,micro:0.6};
  function setLively(on){ livelyBtn.classList.toggle('on',on); livelyBtn.textContent=on?'灵动（开）':'灵动（关）'; params= on?{T:2.2,zeta:0.10,driveK:0.75,deadbandDeg:0.35,micro:0.7}:{T:2.6,zeta:0.14,driveK:0.60,deadbandDeg:0.40,micro:0.2}; }
  setLively(true);
  function addKickDeg(deg){ omega += (deg||60)*Math.PI/180; }
  let bellDegF=0,tzDegF=0,clapDegF=0;
  function step(ts){ if(!lastTS) lastTS=ts; const dt=Math.min(0.05,(ts-lastTS)/1000); lastTS=ts;
    const T=params.T, wn=2*Math.PI/T, zeta=params.zeta+(+rate.value)/1200;
    const r=+rate.value, windFreq=.28+r/380; phase += 2*Math.PI*windFreq*dt;
    const micro=(Math.random()*2-1)*params.micro*Math.PI/180;
    const drive=(5+r*.10)*Math.PI/180*Math.sin(phase)+micro;
    const alpha = -2*zeta*wn*omega - wn*wn*theta + drive*wn*wn*params.driveK;
    omega += alpha*dt; const wClamp=8; if(omega>wClamp)omega=wClamp; else if(omega<-wClamp)omega=-wClamp;
    theta += omega*dt;
    const db=params.deadbandDeg*Math.PI/180;
    if(!running && Math.abs(theta)<db && Math.abs(omega)<db){ theta=0; omega=0; if(raf){cancelAnimationFrame(raf);raf=null;} assembly.setAttribute('transform','rotate(0 180 220)'); bellGroup.removeAttribute('transform'); tanzakuGroup.removeAttribute('transform'); clapper.removeAttribute('transform'); status.textContent='待機中'; return; }
    const deg=theta*180/Math.PI; assembly.setAttribute('transform','rotate('+deg+' 180 220)');
    const sBell=7.0,sTz=4.2,sClap=8.5, lpf=(v,t,s)=> v+(t-v)*(1-Math.exp(-s*dt));
    bellDegF=lpf(bellDegF,deg*.22,sBell); tzDegF=lpf(tzDegF,deg*.42,sTz); clapDegF=lpf(clapDegF,deg*.30,sClap);
    bellGroup.setAttribute('transform','rotate('+bellDegF+' 180 300)'); tanzakuGroup.setAttribute('transform','rotate('+tzDegF+' 180 392)'); clapper.setAttribute('transform','rotate('+clapDegF+' 180 300)');
    raf=requestAnimationFrame(step);
  }
  function startWind(){ if(running)return; running=true; toggle.classList.add('on'); toggle.textContent='停風（停止）'; status.textContent='風在吹：響鈴中…'; if(!raf){lastTS=0;raf=requestAnimationFrame(step);} scheduleLoop(); scheduleGust(); }
  function stopWind(){ running=false; toggle.classList.remove('on'); toggle.textContent='有風（開始）'; status.textContent='待機中'; clearTimeout(windTimer); windTimer=null; }
  function scheduleLoop(){ const r=+rate.value, base=2000-r*15, jitter=Math.random()*600; windTimer=setTimeout(()=>{ chime(); if(running) scheduleLoop(); }, Math.max(300, base+jitter)); }

  function bind(el, fn){ el.addEventListener('click', function(e){ fn(e); flashDot(); }, {passive:false}); el.addEventListener('touchend', function(e){ fn(e); flashDot(); }, {passive:false}); }
  bind(toggle, ()=>{ if(audioCtx.state==='suspended') audioCtx.resume(); running?stopWind():startWind(); });
  bind(one, ()=>{ if(audioCtx.state==='suspended') audioCtx.resume(); chime(); if(!running){ if(!raf){ lastTS=0; raf=requestAnimationFrame(step); } } });
  bind(livelyBtn, ()=>{ setLively(!livelyBtn.classList.contains('on')); });

  function scheduleGust(){ if(!gustEnabled||!running) return; const next=1000+Math.random()*5000; gustTimer=setTimeout(()=>{ const bursts=1+Math.floor(Math.random()*3); const kick=8+Math.random()*8; addKickDeg(kick*6); chime(); let i=1; function more(){ if(i>=bursts) return scheduleGust(); addKickDeg(kick*6*(0.7**i)); chime(); i++; setTimeout(more, 200+Math.random()*300); } setTimeout(more, 200+Math.random()*300); }, next); }
  bind(gustBtn, ()=>{ gustEnabled=!gustEnabled; gustBtn.classList.toggle('on',gustEnabled); gustBtn.textContent=gustEnabled?'陣風（開）':'陣風（關）'; if(gustEnabled) scheduleGust(); else if(gustTimer){ clearTimeout(gustTimer); gustTimer=null; } });

  // ambience toggle
  (function(){ const ctx=audioCtx; let ocean={started:false,gain:null};
    function ensure(){ if(!ocean.started){ const n=ctx.createScriptProcessor(2048,1,1), f=ctx.createBiquadFilter(), g=ctx.createGain(), lfo=ctx.createOscillator(), lg=ctx.createGain();
      let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; n.onaudioprocess=e=>{ const out=e.outputBuffer.getChannelData(0); for(let i=0;i<out.length;i++){ const w=Math.random()*2-1;
        b0=0.99886*b0+w*0.0555179; b1=0.99332*b1+w*0.0750759; b2=0.96900*b2+w*0.1538520; b3=0.86650*b3+w*0.3104856; b4=0.55000*b4+w*0.5329522; b5=-0.7616*b5-w*0.0168980; out[i]=(b0+b1+b2+b3+b4+b5+b6 + w*0.5362)*0.08; b6=w*0.115926; } };
      f.type='lowpass'; f.frequency.value=700; g.gain.value=0.22; lfo.frequency.value=0.09; lg.gain.value=0.35; lfo.connect(lg); lg.connect(g.gain); n.connect(f).connect(g).connect(ctx.destination); lfo.start(); ocean={started:true,gain:g}; } }
    ensure();
    bind(ambience, ()=>{ ensure(); if(ambience.classList.contains('on')){ ocean.gain.gain.cancelScheduledValues(audioCtx.currentTime); ocean.gain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + 0.6); ambience.classList.remove('on'); ambience.textContent='海浪聲（關）'; } else { if(audioCtx.state==='suspended') audioCtx.resume(); ocean.gain.gain.cancelScheduledValues(audioCtx.currentTime); ocean.gain.gain.linearRampToValueAtTime(0.22, audioCtx.currentTime + 0.8); ambience.classList.add('on'); ambience.textContent='海浪聲（開）'; } });
  })();

  // hanabi omitted here to keep size smaller in this diagnostic; reuse previous v21 logic if needed.
}
// robust init: any of these will work
if(document.readyState==='complete' || document.readyState==='interactive'){ setTimeout(init, 0); }
window.addEventListener('DOMContentLoaded', init, {once:true});
window.addEventListener('load', init, {once:true});
</script>
</body>
</html>
